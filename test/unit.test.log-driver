#!/bin/sh
# Custom test log driver for unit.test to capture "###### TESTSUITE SUCCESS" message

# Get the test name and arguments
test_name=$1
shift

# Create the log file directory if it doesn't exist
log_dir=$(dirname "$test_name.log")
mkdir -p "$log_dir"

# Run the test and capture its output
"$@" > "$test_name.log" 2>&1
test_exit=$?

# Create the .trs file
if [ $test_exit -eq 0 ]; then
  echo ":test-result: PASS" > "$test_name.trs"
  echo ":global-test-result: PASS" >> "$test_name.trs"
  echo ":recheck: no" >> "$test_name.trs"
  echo ":copy-in-global-log: yes" >> "$test_name.trs"
else
  echo ":test-result: FAIL" > "$test_name.trs"
  echo ":global-test-result: FAIL" >> "$test_name.trs"
  echo ":recheck: yes" >> "$test_name.trs"
  echo ":copy-in-global-log: yes" >> "$test_name.trs"
fi

# Append the test output to test-suite.log
if [ -f "$test_name.log" ]; then
  cat "$test_name.log" >> "$(dirname "$test_name")/test-suite.log"
fi

exit $test_exit
